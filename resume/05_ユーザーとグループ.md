# ユーザとグループ

## はじめに
- ユーザの種類と概要（一般、システム、root）
- root ユーザの利用
- グループ概要
- ユーザとグループの管理
- ユーザのパスワード変更
- ユーザ変更


## 【WIP】残り項目
- [済]ユーザーの種類と概要（一般、システム、root）
- [未]root ユーザーの利用
- [済]グループ概要
- [未]ユーザーとグループの管理
- [未]ユーザーのパスワード変更
- [未]ユーザー変更
- [済]ファイルの所有者と所有グループ
- [済]所有者と所有グループの変更
- [済]ファイルとディレクトリのアクセス権
- [済]パーミッションの変更

## 【WIP】残りコマンド
- [未]id
- [未]useradd
- [未]userdel
- [未]passwd
- [未]groupadd
- [未]groupdel
- [未]sudo
- [未]/etc/passwd
- [未]/etc/group
- [済]ls -l
- [未]chown
- [済]chmod
- [未]umask
- [未]visudo

## 前置き
Linuxは、1つのマシンへ複数のユーザが同時にログインして操作することを前提として作られています。ということは、秘密にしておきたいファイルを他のユーザに見られてしまっては困ってしまいますし、意図せず他のユーザのファイルを書き換えてしまうことを防ぐ必要もあります。そういったファイル保護を実現するためのアクセス権限や各種ユーザについて解説します。

## ユーザの種類
Linuxにおけるユーザは、「rootユーザ」「一般ユーザ」「システムアカウント」の3種類に区別されます。概要は下記の表のとおりです。<br>

| 種類 | 意味 |
|:-----:|:-----:|
| rootユーザ(システム管理者/スーパーユーザ) |システムに対してすべての権限を持つアカウント |
| 一般ユーザ | システムを利用する側の人やアカウントで使えるコマンドに制限がある |
| システムアカウント | システム内部で特定のアプリケーションを動かす専用のアカウント |


### rootユーザ
システム管理者用のアカウントです。「rootユーザ」や「root」、「スーパーユーザ」などと呼ばれます。rootユーザはあらゆる操作が許可された強い権限を持つユーザであり、システムの設定ファイルの変更や、新しいアプリケーションをインストールしたりすることが可能です。<br>
ファイルの権限設定の影響を受けずに全てのファイル操作ができてしまうので、**通常は一般ユーザとして操作し、必要なときだけrootユーザとして作業する**というように、利用を最小限に留めることが重要です。<br>


## sudoコマンド_コマンドをrootユーザとして実行する
**通常は一般ユーザとして操作し、必要なときだけrootユーザとして作業する**ためにはsudoコマンドを利用します。下記の例では、`/etc/shadow'というコマンドは実行できませんが、sudoをつけることによって実行することができています。<br>
※sudoを付けた場合、パスワードが要求されるのが一般的ですが、Cloud9の場合はパスワードを入力せずに実行できます。

```bash
$ cat /etc/shadow
cat: /etc/shadow: Permission denied
$ sudo cat /etc/shadow
root:*:16819:0:99999:7:::

# 以下省略
```

## 【WIP】visudo_sudo時の権限を設定する



## 【WIP】ユーザの作成
adduser
/etc/passwd
## 【WIP】ユーザの削除
userdel
## 【WIP】ユーザの切り替えとログアウト
su
exit
## 【WIP】ユーザの確認
id




============





## ファイルのオーナーとグループ
Linuxで扱われるファイルは必ずオーナー(所有者)が設定されてます。ファイルのオーナーは所有ファイルのアクセス権限を自由に設定できます。<br>
ファイルの所有者を調べるには`ls -l`コマンドを使います。<br>
`/bin/cat`の所有者を調べてみましょう(ちなみに、ここにはcatコマンドの情報が格納されています)。

```bash
$ ls -l /bin/cat
-rwxr-xr-x 1 root root 47904 Dec  3  2015 /bin/cat*
```

<img src="images/cat-owner.png">

出力結果の3列目と4列目にファイルのオーナーおよびファイルの所属グループが表示されます(グループやその他の情報については後述します)。<br>
つまり、この`/bin/cat`というファイルは`root`ユーザがオーナーで、`root`というグループに所属しているということになります。<br>
では、改めて現在のユーザを確認してファイルを生成し、そのオーナーを調べて見ましょう。<br>

```bash
$ whoami # 現在のユーザの確認
ubuntu
$ touch file1.txt
$ ls -l
total 1
-rw-r--r-- 1 ubuntu ubuntu    0 Oct 10 07:09 file1.txt
```

今度は、`ubuntu`というユーザがファイルを生成したので、そのユーザがファイルのオーナーになるわけですね。<br>

## グループとは
前述した「グループ」とはユーザの集合です。例えば、システム管理を行うグループを「wheel」とし、wheelグループには管理者権限を与えます。そして、wheelには複数の管理者ユーザを所属させることで、同じ役割を持つ複数のユーザに同一の権限を付与することができます。<br>
ユーザをは同時に複数のグループに所属することが可能であり、少なくとも1つのグループに所属する必要があります。ユーザを新規作成する際にグループを指定しなければ、自動的にユーザ名と同一のグループに所属することになります。<br>
自分が現在どのグループに所属しているかは`groups`コマンドで確認できます。下記の例では、3つのグループ(ubuntu, sudo, rvm)に所属していることがわかります。

```bash
$ groups
ubuntu sudo rvm
```


## 【WIP】グループの作成
groupadd
/etc/group
## 【WIP】グループの削除
groupdel
## 【WIP】グループの切り替え
## 【WIP】グループの確認
id
## 【WIP】chownコマンド_所有者と所有グループの変更
chown

## ファイルのパーミッション(アクセス権限)
続いてファイルのパーミッションの話です。パーミッションとはアクセス権限、すなわち「**誰にどのような操作を許可するか**」という見解を規定する情報を意味します。ファイルのパーミッションも`ls -l`で確認することができます。<br>
先程確認した`/bin/cat`をもう一度見てみましょう。<br>

<img src="images/cat-permission.png">

今回は`-rwxr-xr-x`の部分に注目します。<br>
まず先頭の「-」ですが、これはファイルの種類を意味します。「-」は通常ファイル、「d」はディレクトリ、「l」はシンボリックリンクです。<br>
次に`rwxr-xr-x`ですが、これは、`rwx` `r-x` `r-x`という3文字ごとに1つのブロックになっており、それぞれが「オーナー」「グループ」「その他のユーザ」に対するパーミッション(アクセス権限)を意味します。<br>


<img src="images/permissions.png">

「r」「w」「x」「-」それぞれの意味は下記のとおりです。<br>

| 記号 | 意味 |
|:----:|:-----:|
| r | 読み取り(**r**ead)  |
| w | 書き込み(**w**rite) |
| x | 実行(e**x**ecute)   |
| - | 許可されていない    |

つまり先程の`/bin/cat`のパーミッションをまとめると次のようになります。(◯が許可、✕が禁止を意味します)。<br>

| ユーザ | 読み取り | 書き込み | 実行 |
|:------:|:--------:|:--------:|:-----:|
| オーナー               | ◯ | ◯ | ◯ |
| rootグループ所属ユーザ | ◯ | ✕ | ◯ |
| その他のユーザ         | ◯ | ✕ | ◯ |

### 補足1_読み取り権限
読み取り権限とは、文字通り、読み取りができるかどうかという意味です。例えば、`/etc/sudoers`というファイルは下記のようなパーミッションが設定されているので現在ユーザ(ubuntu)およびグループ(ubuntu)では読み取りが許可されていないので、catコマンドで内容を見ようとしても出来ません。<br>

```bash
$ ls -l /etc/sudoers
-r--r----- 1 root root 682 Aug 31 05:44 /etc/sudoers
$ cat /etc/sudoers
cat: /etc/sudoers: Permission denied
```

### 補足2_書き込み権限
書き込み権限もそのままの意味で、ファイルに内容を書き込むことができるかどうかという意味です。例えば、上で紹介した`/etc/sudoers`では書き込み権限が与えられていないので、編集しようとしてもできません(ためしにCloud9上のエディタやviコマンドを実行してみましょう)。

### 補足3_実行権限
最後に実行権限です。`/etc/crontab`には現在のユーザでは実行権限がありません。その状況で実際にコマンド実行すると、下記のように「Perfmission denied」となります。<br>

```bash
$ ls -l /etc/crontab
-rw-r--r-- 1 root root 722 Feb  9  2013 /etc/crontab
$ /etc/crontab
bash: /etc/crontab: Permission denied
```

## ディレクトリのパーミッション
ここまでファイルのパーミッションをみてきましたが、ディレクトリにもパーミッションが設定されています。ファイルと同じく「r」「w」「x」の記号が使われますが、ファイルとは少々違う意味になります。<br>


| 記号 | 意味 | 詳細 |
|:----:|:-----:|:-----:|
| r | 読み取り(**r**ead)  | ディレクトリに含まれるファイル一覧の取得 |
| w | 書き込み(**w**rite) | ディレクトリの下にあるファイルおよびディレクトリの作成と削除 |
| x | 実行(e**x**ecute)   | ディレクトリをカレントディレクトリとする |


### ディレクトリの読み取り権限
ディレクトリの読み取り権限を試してみましょう。下記の例では、`dir1`には読み取り権限がないので、lsで中身を見ることができません(chmodコマンドはファイルモードの変更で解説します)。<br>

```bash
$ mkdir dir1
$ chmod 333 dir1
$ cd dir1
$ ls -l
total 4
d-wx-wx--x 2 ubuntu ubuntu 4096 Oct 10 08:10 dir1/
$ ls dir1/
ls: cannot open directory dir1/: Permission denied
```

### ディレクトリの書き込み権限
ディレクトリに書き込み権限が設定されている場合、そのディレクトリ下のファイルの作成・削除が出来るようになります。ここでポイントとなるのが「
**ファイルの削除はディレクトリのパーミッションで決まる**」のであって、ファイル自身のパーミッションは関係ないという点です。<br>
下記の例では`readonly.txt`は読み取り権限しかありませんが、所属している`dir1`ディレクトリには書き込み権限が許可されているので、`readonly.txt`の削除はできてしまいます。


```bash
$ pwd # dir1ディレクトリにいることを確認
/home/ubuntu/workspace/dir1
$ touch readonly.txt
$ chmod 444 readonly.txt # パーミッションの設定
$ ls -l readonly.txt
-r--r--r-- 1 ubuntu ubuntu 0 Oct 10 08:14 dir1/readonly.txt
$ rm readonly.txt        # readonly.txtの削除
rm: remove write-protected regular empty file ‘readonly.txt’? yes
```

### ディレクトリの実行権限
ディレクトリの実行権限が禁止されている場合、cdコマンドでディレクトリを切り替えたり、ディレクトリ下にあるファイルの読み書きが出来ません。<br>

```bash
$ mkdir dir2
$ chmod 444 dir2
$ ls -l
total 2
dr--r--r-- 2 ubuntu ubuntu 4096 Oct 10 08:24 dir2/
$ cd dir2
bash: cd: dir2: Permission denied
```

### ディレクトリのパーミッションをどうするか
ディレクトリのパーミッションについてみてきましたが、実際にはどのようなパーミッションにすればよいのでしょうか。おおまかな指針だけ示しておきます。

| 設定 | 内容 |
|:----:|:----:|
| rwxr-xr-x | 他のユーザから閲覧されてもよいディレクトリ。ただし、ファイルの作成や削除はできない。 |
| rwx------ | 他のユーザからディレクトリ内容を知られたくないとき。 |


## chmodコマンド_ファイルモードの変更
ファイルやディレクトリのパーミッションを設定するにはchmodコマンドを利用します。chmodコマンドによるパーミッション指定には2つの方法(シンボルモードと数値モード)がありますが、1つずつみていきましょう。<br>
また、ファイルのパーミッションを変更できるのは、そのオーナーか後述するスーパーユーザのみです。誰でもファイルのパーミッションを自由に設定できては意味がないので当然といえます。<br>

## シンボルモードによる指定
まずはシンボルモードによる指定をみていきましょう。構文は下記のとおりです。シンボルモードは「誰に」「どのような権限を追加(禁止)」するかという書き方です。

### シンボルモードの構文
```bash
$ chmod [ugoa] [+-=] [rwx] <ファイル名>
```

#### ユーザ指定(ugoa)の意味
| 記号 | 意味 |
|:------:|:------:|
| u | オーナー       |
| g | グループ       |
| o | その他のユーザ |
| a | ugoすべて      |

#### 演算子(+0=)の意味
| 記号 | 意味 |
|:------:|:------:|
| + | 権限を追加する |
| - | 権限を禁止する |
| = | 指定した権限と等しくする |


### 書き込み権限の追加
では、実際に権限を追加してみましょう。下記の例では、グループに書き込み権限(w)を付与しています。<br>

```bash
$ mkdir dir3
$ ls -l
total 2
drwxr-xr-x 2 ubuntu ubuntu 4096 Oct 10 08:34 dir3/
$ chmod g+w dir3
$ ls -l
total 2
drwxrwxr-x 2 ubuntu ubuntu 4096 Oct 10 08:34 dir3/
```

<img src="images/chmod_gw.png">


### 読み込み権限削除
次は読み込み権限を削除してみます。

```bash
$ mkdir dir4
$ ls -l
total 2
drwxr-xr-x 2 ubuntu ubuntu 4096 Oct 10 08:43 dir4/
$ chmod g-r dir4
$ ls -l
total 2
drwx--xr-x 2 ubuntu ubuntu 4096 Oct 10 08:43 dir4/
```

### 複数のユーザの権限をまとめて指定する
複数のユーザの権限をまとめて設定しています。「=」の使い方に着目してください。<br>

```bash
mohira:~/workspace $ mkdir dir5
mohira:~/workspace $ ls -l
total 2
drwxr-xr-x 2 ubuntu ubuntu 4096 Oct 10 08:46 dir5/
mohira:~/workspace $ chmod go=r dir5
mohira:~/workspace $ ls -l
total 2
drwxr--r-- 2 ubuntu ubuntu 4096 Oct 10 08:46 dir5/
```

### シンボルモードの使い方
シンボルモードは相対的な指定方法なので、指定したパーミッション以外は変化しません。シンボルモードは「オーナーの権限だけ」などどいったパーミッションの一部を変更したいときに便利です。<br>


## 数値モードによる指定
シンボルモードは相対的な指定でしたが、数値モードは**元のパーミッションに関わらず新しいパーミッションの値へと変更する**という絶対的な指定方法です。

### 数値モードの構文
```bash
$ chmod <8進数の数値> <ファイル名>
```

#### 8進数の数値指定の指定
8進数とは0から7までの数字で構成されている世界です。普段われわれが使っているのは10進数で0から9までの数字で構成されています。<br>
足した値を「オーナー」「グループ」「その他のユーザ」の順に3つ並べて指定します。例えば、「rwxr-xr-x」をしてする場合は「755」となります。<br>

| 意味 | 対応する数字|
|:----:|:-----------:|
| 読み取り(r) | 4 |
| 書き込み(w) | 2 |
| 実行(x)     | 1 |

### 数値モードでパーミッション指定する
では実際に試してみましょう。下記の例は、`index.html`に「rwxr-xr-x」(755)を指定する場合です。<br>

```bash
$ touch index.html
$ ls -l
total 0
-rw-r--r-- 1 ubuntu ubuntu 0 Oct 10 09:00 index.html
$ chmod 755 index.html
$ ls -l
total 0
-rwxr-xr-x 1 ubuntu ubuntu 0 Oct 10 09:00 index.html*
```

<img src="images/chmod_755.png">

## 【WIP】umaskコマンド_パーミッションのマスク
